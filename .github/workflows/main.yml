name: Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  unit:
    runs-on: ubuntu-latest
    name: Unit (Ruby ${{ matrix.ruby }})
    strategy:
      matrix:
        ruby: ["3.2", "3.3", "4.0"]

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
      - name: Run unit specs
        env:
          COVERAGE: "1"
          COVERAGE_MIN_LINE: "95"
        run: bundle exec rspec spec/unit spec/ptrace_spec.rb
      - name: Build YARD database
        run: bundle exec yard doc -n --no-cache

  integration:
    runs-on: ubuntu-latest
    name: Integration (Ruby 3.3)
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true
      - name: Relax ptrace Yama policy
        run: sudo sysctl kernel.yama.ptrace_scope=0
      - name: Run integration specs
        env:
          PTRACE_RUN_INTEGRATION: "1"
        run: bundle exec rspec spec/integration
